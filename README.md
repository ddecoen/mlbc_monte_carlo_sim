# MLBC Monte Carlo Sim (High Heat 2003)

A Fangraphs-style projection engine for the **MLBC Sim League** (High Heat Baseball 2003).  
This project scrapes league/player pages into a **SQLite** database, then generates hitter projections using a **Monte Carlo simulation** approach with league context + park effects.

## What it does

### Data pipeline (SQLite)
- Discovers player IDs from league leader pages (supports paging beyond the top 50)
- Scrapes player cards and season batting lines
- Scrapes player splits (home/away + monthly)
- Scrapes team → stadium history (year-bounded)
- Stores everything in a single SQLite DB for repeatable modeling

### Projection model (Monte Carlo)
- Uses a rolling recent-performance baseline (e.g., last 3 seasons)
- Regresses toward league average based on a configurable prior (`--k-ab`)
- Adjusts outcomes for:
  - **Park factors** (home/away blended)
    - computed from MLBC home/away splits
    - optionally blended with a **Baseball Savant prior** (index_wOBA) for stability in low-sample stadium-years
  - **Batted-ball profile** (GB% impacts HR/SLG/OPS tails)
  - Variance scaling (fat/skinny tails)
- Produces percentile outcomes:
  - OPS p10 / p50 / p90
  - HR p10 / p50 / p90


## Park factors (MLBC + optional Savant prior)

### Build / update Savant priors (CSV)

```bash
python3 savant_park_factors_to_csv.py --year 2002 --batside L --rolling 3 \
  --stat index_wOBA --out data/savant_park_factors_prior.csv
```

### Compute MLBC park factors (with optional Savant blending)

```bash
python3 mlbc_parkfactors.py --db mlbc.sqlite \
  --savant-prior-csv data/savant_park_factors_prior.csv \
  --savant-k-ab 2500
```

Notes:
- Stadium→venue mapping is automatic (normalized + fuzzy match + a small alias list in code).
- The blended PF and diagnostics are stored in `park_factors_team_year`:
  `pf_ops_index` (final), plus `pf_ops_index_mlbc`, `pf_ops_index_prior`, `pf_ops_blend_w`.

## Free agent / destination stadium projections

In Streamlit, enable **Compare vs destination team park** and choose a destination team.
The app will show baseline results and destination deltas (OPS_p50 / HR_p50).

You can also call `project_players(..., override_team="...")` directly.
### Interfaces
- **CLI**: run projections for one or many player IDs
- **Streamlit app**: interactive table and league context

---

## Refreshing / rebuilding the SQLite database

This project is designed around a local SQLite file (`mlbc.sqlite`). The DB is generated by scraping MLBC pages and then (optionally) computing park factors.

> Tip: Always use the repo venv when scraping.

### 1) Create / activate a venv

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### 2) Scrape data into `mlbc.sqlite`

The scraper is idempotent-ish: it will upsert/replace the relevant rows as you re-run it.

Typical workflow (adjust flags to match how you run the scraper today):

```bash
# Create the DB + tables (if needed) and scrape core hitter data
python3 mlbc_scrape.py --db mlbc.sqlite --players
python3 mlbc_scrape.py --db mlbc.sqlite --ids
python3 mlbc_scrape.py --db mlbc.sqlite --batting
python3 mlbc_scrape.py --db mlbc.sqlite --splits

# Stadium lease history (team → stadium by year)
python3 mlbc_scrape.py --db mlbc.sqlite --stadiums
```

Notes:
- **Player ID discovery** comes from league leader pages; paging is supported beyond the top 50.
- Stadium history is stored in `team_stadiums` and is *year-bounded* (supports lease changes over time).

### 3) Backfill / validate ages (recommended)

MLBC season batting lines don’t always include an age column directly, so the pipeline supports backfilling `player_season_batting.age` using the player card “Age: XX” and the player’s most recent season year.

If you see obviously wrong ages in projections, re-run the age backfill step (whatever script/function you’re currently using) and then confirm with a quick query.

### 4) Recompute park factors (recommended)

Park factors are stored in `park_factors_team_year` and are currently computed as a **proxy using team home/away splits** (since true stadium-by-year factors aren’t available).

```bash
python3 mlbc_parkfactors.py --db mlbc.sqlite \
  --savant-prior-csv data/savant_park_factors_prior.csv \
  --savant-k-ab 2500
```

Important:
- The **projection engine can resolve park factors using either team abbreviations or full team names** (via `team_aliases`).
- For destination-park comparisons in Streamlit, “stadium mode” uses the stadium’s tenant team as the PF proxy.

### 5) Sanity-check the DB quickly

```bash
python - <<'PY'
import sqlite3
con = sqlite3.connect('mlbc.sqlite')
cur = con.cursor()
print('players:', cur.execute('select count(*) from players').fetchone()[0])
print('batting rows:', cur.execute('select count(*) from player_season_batting').fetchone()[0])
print('teams (batting):', cur.execute('select count(distinct team) from player_season_batting').fetchone()[0])
print('stadium leases:', cur.execute('select count(*) from team_stadiums').fetchone()[0])
print('park factors:', cur.execute('select count(*) from park_factors_team_year').fetchone()[0])
con.close()
PY
```

## Repo layout (expected)

```text
.
├── mlbc_scrape.py          # Scrape + ingest into SQLite
├── mlbc_project.py         # Projection engine + CLI entrypoint
├── mlbc_app.py             # Streamlit UI
├── mlbc.sqlite             # Generated DB (optional to commit; usually ignored)
├── requirements.txt
└── README.md

